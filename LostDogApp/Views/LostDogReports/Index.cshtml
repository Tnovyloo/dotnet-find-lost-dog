@model LostDogApp.ViewModels.LostDogReportViewModels.IndexFilterViewModel

@{
    ViewData["Title"] = "Index";
}

<h1>Wszystkie zgubione pupile</h1>

<p>
    <a asp-action="Create" class="btn btn-primary">Stwórz ogłoszenie</a>
    <form asp-action="SeedDogs" method="post" asp-controller="LostDogReports">
        <button type="submit" class="btn btn-primary">Seed Dogs</button>
    </form>
</p>

<div id="map" style="height: 500px; margin-bottom: 20px;"></div>

<form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
        <input type="text" name="dogNameQuery" value="@Model.DogNameQuery" class="form-control" placeholder="Imię psa" />
    </div>
    <div class="col-md-3">
        <select name="selectedVoivodeship" class="form-select">
            <option value="">-- Województwo --</option>
            @foreach (var v in Model.AvailableVoivodeships)
            {
                <option value="@v" selected="@(v == Model.SelectedVoivodeship)">
                    @v
                </option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <select name="selectedCity" class="form-select">
            <option value="">-- Miasto --</option>
            @foreach (var c in Model.AvailableCities)
            {
                <option value="@c" selected="@(c == Model.SelectedCity)">
                    @c
                </option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <button type="submit" class="btn btn-primary">Filtruj</button>
        <a type="" class="btn btn-danger" asp-controller="LostDogReports" asp-action="Index">Usun</a>
    </div>
</form>

<table class="table">
    <thead>
        <tr>
            <th>
                Zdjecie
            </th>
            <th>
                @* @Html.DisplayNameFor(model => model.DogName) *@
                Imie psa
            </th>
            <th>
                @* @Html.DisplayNameFor(model => model.Description) *@
                Opis
            </th>
            <th>
                Sz. Geograficzna
            </th>
            <th>
                Dł. Geograficzna
            </th>
            <th>
                Numer kontaktowy
            </th>
            <td>Miasto</td>
            <td>Wojewodztwo</td>
            <th></th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model.Reports) {
        <tr>
            <td>
                <img src="@Html.DisplayFor(modelItem => item.ImagePath)" alt="" style="height: 100px;"> 
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.DogName)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Description)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Latitude)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Longitude)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ContactNumber)
            </td>
            <td>@(item.City?.Name ?? "Nieznane")</td>
            <td>@(item.City?.Voivodeship ?? "Nieznane")</td>
            <td>
                @* <a asp-action="Edit" asp-route-id="@item.Id">Edit</a> | *@
                <a asp-action="Details" asp-route-id="@item.Id">Szczegóły</a>
                @* <a asp-action="Delete" asp-route-id="@item.Id">Delete</a> *@
            </td>
        </tr>
}
    </tbody>
</table>

@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([0, 0], 2); // Default view

        // Add tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var bounds = [];

        // Dog marker data from Razor
        var dogReports = [
            @foreach (var dog in Model.Reports)
            {
                if (dog.Latitude != 0 && dog.Longitude != 0)
                {
                    var detailsUrl = Url.Action("Details", "LostDogReports", new { id = dog.Id });

                    <text>
                    {
                        lat: @dog.Latitude,
                        lng: @dog.Longitude,
                        name: "@dog.DogName",
                        description: "@dog.Description",
                        image_path: "@dog.ImagePath",
                        details_url: "@detailsUrl",
                    },
                    </text>
                }
            }
        ];

        // Add markers
        dogReports.forEach(function (report) {
            var marker = L.marker([report.lat, report.lng])
                .addTo(map)
                .bindPopup(`<img style="height: 100px" src="${report.image_path}" ></img><strong>` + report.name + "</strong><br/>" + report.description + `<a href="${report.details_url}">Zobacz ogłoszenie</a>`);
            bounds.push([report.lat, report.lng]);
        });

        // Fit map to markers
        if (bounds.length > 0) {
            map.fitBounds(bounds);
        }
    </script>
}
